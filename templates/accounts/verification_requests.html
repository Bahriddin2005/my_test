{% extends 'base.html' %}
{% load static %}

{% block title %}Foydalanuvchilarni Tasdiqlash - Buxoro Bilimdonlar Maktabi{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="glass-card p-4 mb-4" data-aos="fade-down">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-white mb-1">
                        <i class="fas fa-user-check me-2"></i>
                        Foydalanuvchilarni Tasdiqlash
                    </h2>
                    <p class="text-white-50 mb-0">Yangi ro'yxatdan o'tgan foydalanuvchilarni tasdiqlang</p>
                </div>
                <div>
                    <span class="badge bg-warning fs-6" id="pendingCount">--</span>
                </div>
            </div>
        </div>

        <div class="glass-card p-4" data-aos="fade-up">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-white mb-0">
                    <i class="fas fa-list me-2"></i>
                    Kutilayotgan So'rovlar
                </h4>
                <button class="btn btn-outline-light" onclick="refreshRequests()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Yangilash
                </button>
            </div>

            <div id="loadingIndicator" class="text-center py-4">
                <div class="text-white">
                    <div class="loading d-inline-block"></div>
                    <p class="mt-2">Yuklanmoqda...</p>
                </div>
            </div>

            <div id="requestsList" class="d-none">
                <!-- Verification requests will be loaded here -->
            </div>

            <div id="noRequests" class="text-center py-5 d-none">
                <div class="text-white-50">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h4>Barcha so'rovlar ko'rib chiqildi!</h4>
                    <p>Hozircha tasdiqlanishi kerak bo'lgan yangi foydalanuvchilar yo'q.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-white">
                    <i class="fas fa-user me-2"></i>Foydalanuvchi Ma'lumotlari
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- User details will be loaded here -->
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
                <button type="button" class="btn btn-success" onclick="approveFromModal()">
                    <i class="fas fa-check me-1"></i>Tasdiqlash
                </button>
                <button type="button" class="btn btn-danger" onclick="showRejectModal()">
                    <i class="fas fa-times me-1"></i>Rad etish
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-white">
                    <i class="fas fa-times me-2"></i>So'rovni Rad Etish
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label text-white">Rad etish sababi</label>
                    <textarea class="form-control" id="rejectionReason" rows="4" 
                              placeholder="Nima uchun so'rov rad etilayotganini tushuntiring..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-danger" onclick="rejectFromModal()">
                    <i class="fas fa-times me-1"></i>Rad Etish
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentRequestId = null;
    let verificationRequests = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadVerificationRequests();
    });

    async function loadVerificationRequests() {
        try {
            console.log('Loading verification requests...');
            const response = await fetch('{% url "accounts:verification_requests" %}', {
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            console.log('Response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Received data:', data);
                verificationRequests = data.requests;
                displayRequests();
            } else {
                console.error('Response not ok:', response.status);
                showAlert('Ma\'lumotlarni yuklashda xatolik yuz berdi', 'danger');
            }
        } catch (error) {
            console.error('Fetch error:', error);
            showAlert('Server bilan bog\'lanishda xatolik yuz berdi', 'danger');
        }
    }

    function displayRequests() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const requestsList = document.getElementById('requestsList');
        const noRequests = document.getElementById('noRequests');
        const pendingCount = document.getElementById('pendingCount');

        loadingIndicator.classList.add('d-none');
        
        if (verificationRequests.length === 0) {
            noRequests.classList.remove('d-none');
            requestsList.classList.add('d-none');
            pendingCount.textContent = '0';
            return;
        }

        noRequests.classList.add('d-none');
        requestsList.classList.remove('d-none');
        pendingCount.textContent = verificationRequests.length;

        let html = '';
        
        verificationRequests.forEach((request, index) => {
            const user = request.user;
            const requestDate = new Date(request.requested_at).toLocaleDateString('uz-UZ');
            
            html += `
                <div class="glass-card p-4 mb-3" data-aos="fade-up" data-aos-delay="${index * 100}">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                     style="width: 60px; height: 60px;">
                                    <i class="fas fa-user fa-lg text-white"></i>
                                </div>
                                <span class="badge bg-secondary">${getRoleDisplayName(user.role)}</span>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5 class="text-white mb-1">${user.first_name} ${user.last_name}</h5>
                            <p class="text-white-50 mb-1">
                                <i class="fas fa-at me-1"></i>${user.username}
                            </p>
                            <p class="text-white-50 mb-1">
                                <i class="fas fa-envelope me-1"></i>${user.email}
                            </p>
                            ${user.role === 'student' ? `
                                <p class="text-white-50 mb-0">
                                    <i class="fas fa-graduation-cap me-1"></i>${user.grade || '--'}-sinf 
                                    ${user.class_name ? `(${user.class_name})` : ''}
                                </p>
                            ` : user.role === 'teacher' ? `
                                <p class="text-white-50 mb-0">
                                    <i class="fas fa-book me-1"></i>${user.subject || 'Fan ko\'rsatilmagan'}
                                </p>
                            ` : ''}
                        </div>
                        
                        <div class="col-md-2">
                            <div class="text-center">
                                <small class="text-white-50 d-block">So'rov sanasi</small>
                                <span class="text-white">${requestDate}</span>
                            </div>
                        </div>
                        
                        <div class="col-md-2">
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-success btn-sm" onclick="showUserDetails(${request.id})">
                                    <i class="fas fa-eye me-1"></i>Ko'rish
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="approveRequest(${request.id})">
                                    <i class="fas fa-check me-1"></i>Tasdiqlash
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="rejectRequest(${request.id})">
                                    <i class="fas fa-times me-1"></i>Rad etish
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        requestsList.innerHTML = html;
        
        // Re-initialize AOS for new elements
        AOS.refresh();
    }

    function getRoleDisplayName(role) {
        const roles = {
            'student': 'O\'quvchi',
            'teacher': 'O\'qituvchi',
            'admin': 'Administrator'
        };
        return roles[role] || role;
    }

    function showUserDetails(requestId) {
        const request = verificationRequests.find(r => r.id === requestId);
        if (!request) return;

        currentRequestId = requestId;
        const user = request.user;
        
        const content = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-white mb-2">Shaxsiy Ma'lumotlar</h6>
                    <ul class="list-unstyled text-white-50">
                        <li class="mb-2"><strong>Ism:</strong> ${user.first_name}</li>
                        <li class="mb-2"><strong>Familiya:</strong> ${user.last_name}</li>
                        <li class="mb-2"><strong>Foydalanuvchi nomi:</strong> ${user.username}</li>
                        <li class="mb-2"><strong>Email:</strong> ${user.email}</li>
                        <li class="mb-2"><strong>Rol:</strong> ${getRoleDisplayName(user.role)}</li>
                    </ul>
                </div>
                
                <div class="col-md-6">
                    <h6 class="text-white mb-2">Qo'shimcha Ma'lumotlar</h6>
                    <ul class="list-unstyled text-white-50">
                        ${user.role === 'student' ? `
                            <li class="mb-2"><strong>O'quvchi ID:</strong> ${user.student_id || 'Ko\'rsatilmagan'}</li>
                            <li class="mb-2"><strong>Sinf:</strong> ${user.grade || '--'}</li>
                            <li class="mb-2"><strong>Sinf nomi:</strong> ${user.class_name || 'Ko\'rsatilmagan'}</li>
                        ` : user.role === 'teacher' ? `
                            <li class="mb-2"><strong>Fan:</strong> ${user.subject || 'Ko\'rsatilmagan'}</li>
                        ` : ''}
                        <li class="mb-2"><strong>So'rov sanasi:</strong> ${new Date(request.requested_at).toLocaleString('uz-UZ')}</li>
                    </ul>
                </div>
            </div>
        `;
        
        document.getElementById('userDetailsContent').innerHTML = content;
        
        const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
        modal.show();
    }

    async function approveRequest(requestId) {
        if (!confirm('Bu foydalanuvchini tasdiqlashni xohlaysizmi?')) return;
        
        try {
            const response = await fetch(`{% url "accounts:approve_verification" 0 %}`.replace('0', requestId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                showAlert('Foydalanuvchi muvaffaqiyatli tasdiqlandi!', 'success');
                // Remove from list
                verificationRequests = verificationRequests.filter(r => r.id !== requestId);
                displayRequests();
            } else {
                const data = await response.json();
                showAlert(data.error || 'Tasdiqlashda xatolik yuz berdi', 'danger');
            }
        } catch (error) {
            showAlert('Server bilan bog\'lanishda xatolik yuz berdi', 'danger');
        }
    }

    function approveFromModal() {
        if (currentRequestId) {
            approveRequest(currentRequestId);
            const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
            modal.hide();
        }
    }

    function rejectRequest(requestId) {
        currentRequestId = requestId;
        showRejectModal();
    }

    function showRejectModal() {
        const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
        modal.show();
    }

    async function rejectFromModal() {
        const reason = document.getElementById('rejectionReason').value.trim();
        
        if (!reason) {
            showAlert('Rad etish sababini ko\'rsating', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`{% url "accounts:reject_verification" 0 %}`.replace('0', currentRequestId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: reason })
            });
            
            if (response.ok) {
                showAlert('Foydalanuvchi so\'rovi rad etildi', 'success');
                // Remove from list
                verificationRequests = verificationRequests.filter(r => r.id !== currentRequestId);
                displayRequests();
                
                // Hide modals
                const rejectModal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
                rejectModal.hide();
                
                const userModal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
                if (userModal) userModal.hide();
                
                // Clear form
                document.getElementById('rejectionReason').value = '';
                
            } else {
                const data = await response.json();
                showAlert(data.error || 'Rad etishda xatolik yuz berdi', 'danger');
            }
        } catch (error) {
            showAlert('Server bilan bog\'lanishda xatolik yuz berdi', 'danger');
        }
    }

    function refreshRequests() {
        document.getElementById('loadingIndicator').classList.remove('d-none');
        document.getElementById('requestsList').classList.add('d-none');
        document.getElementById('noRequests').classList.add('d-none');
        
        loadVerificationRequests();
    }

    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add to page
        document.body.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }
</script>
{% endblock %}
